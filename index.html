<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Le portail vers Harmonia. Créez, partagez, connectez-vous." />
  <title>Portail d'Accès — Harmonia</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- gotrue -->
  <script src="https://unpkg.com/gotrue-js/dist/gotrue.min.js" defer></script>

  <style>
    /* (garde ton CSS inchangé — j'ai laissé le tien tel quel pour la clarté) */
    :root{--bg1:#0f1726;--bg2:#07102b;--accent1:#ff4d6d;--accent2:#7c5cff;--text-light:#e6eef8;--text-muted:#9aa3b2;--border-color:rgba(255,255,255,0.05);--success:#50ffaa;--error:#ff5050}
    *{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth}body{font-family:'Poppins',sans-serif;color:var(--text-light);background:linear-gradient(135deg,var(--bg1),var(--bg2));line-height:1.6}
    .container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
    .wrap{width:100%;max-width:980px;display:grid;grid-template-columns:1fr 420px;gap:2.5rem;align-items:center}
    .hero{padding:2rem;border-radius:1.25rem;background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));box-shadow:0 10px 30px rgba(0,0,0,0.5);border:1px solid var(--border-color)}
    .logo{display:flex;align-items:center;gap:0.75rem;margin-bottom:1.5rem}.badge{width:56px;height:56px;border-radius:.75rem;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-content:center;font-weight:700;font-size:1.5rem;color:#fff}.logo-title{font-weight:700;font-size:1.1rem}.logo-subtitle{font-size:.8rem;color:var(--text-muted)}.hero h1{margin:0;font-size:1.8rem;line-height:1.2;font-weight:600}.hero p{color:var(--text-muted);margin-top:1rem;font-size:.95rem;max-width:560px}.features{display:flex;flex-wrap:wrap;gap:.75rem;margin-top:1.5rem}.feature{background:rgba(255,255,255,0.03);padding:.6rem .9rem;border-radius:.6rem;font-size:.8rem;color:#dfe8ff}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:1rem;padding:2rem;border:1px solid var(--border-color);box-shadow:0 14px 40px rgba(2,6,23,0.6)}
    .form-section{margin-bottom:2.5rem}.form-section:last-child{margin-bottom:0}.form-title{font-size:1.5rem;font-weight:600;text-align:center;margin-bottom:1.5rem}.card-divider{border:none;height:1px;background-color:var(--border-color);margin:2.5rem 0}
    form{margin-top:.5rem}.field{margin-bottom:1rem;text-align:left}label{display:block;font-size:.85rem;color:var(--text-muted);margin-bottom:.4rem}input{width:100%;padding:.8rem 1rem;border-radius:.6rem;border:1px solid var(--border-color);background:rgba(0,0,0,0.25);color:var(--text-light);outline:none;font-size:.9rem;transition:border-color .2s,box-shadow .2s}input:focus-visible{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(124,92,255,.3)}.btn{width:100%;padding:.8rem;border-radius:.6rem;border:none;cursor:pointer;font-weight:700;font-size:1rem;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;margin-top:.5rem;box-shadow:0 8px 20px rgba(124,92,255,.12);transition:transform .2s,box-shadow .2s,opacity .2s}.btn:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(124,92,255,.2)}.btn:disabled{cursor:not-allowed;opacity:.6}.separator{text-align:center;color:var(--text-muted);font-size:.8rem;margin:1.5rem 0;position:relative}.separator span{background:var(--bg1);padding:0 .5rem}.separator::before{content:'';display:block;width:100%;height:1px;background:var(--border-color);position:absolute;left:0;top:50%;z-index:-1}.providers{margin-top:1rem;display:grid;gap:.5rem}.provider-btn{width:100%;padding:.7rem;border-radius:.6rem;cursor:pointer;border:1px solid var(--border-color);display:flex;align-items:center;gap:.7rem;font-weight:600;font-size:.9rem;background:rgba(255,255,255,.02);color:var(--text-light);transition:background-color .2s}.provider-btn:hover{background-color:rgba(255,255,255,.05)}.icon{width:28px;height:28px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#fff}.g{background:#db4437}.f{background:#1877f2}.msg{margin-top:1rem;padding:.8rem 1rem;border-radius:.6rem;font-size:.9rem;border:1px solid transparent;display:none}.msg.is-visible{display:block}.msg.is-error{background:rgba(255,80,80,.08);color:#ffbebe;border-color:rgba(255,80,80,.1)}.msg.is-success{background:rgba(80,255,170,.06);color:#c8ffdf;border-color:rgba(80,255,170,.1)}
    @media (max-width:900px){.wrap{grid-template-columns:1fr;padding:1rem;gap:2rem}.hero{text-align:center}.hero p{max-width:100%}.features{justify-content:center}}
  </style>
</head>

<body>
  <div class="container">
    <div class="wrap">
      <section class="hero">
        <div class="logo">
          <div class="badge">H</div>
          <div>
            <div class="logo-title">Harmonia</div>
            <div class="logo-subtitle">Votre espace de création et de partage.</div>
          </div>
        </div>
        <h1>Bienvenue sur Harmonia.</h1>
        <p>Explorez des communautés, forgez des alliances, vivez des expériences uniques. Ici, la connexion est réinventée.</p>
        <div class="features" role="list">
          <div class="feature" role="listitem">Communautés & Chat</div>
          <div class="feature" role="listitem">Jeux et Événements</div>
          <div class="feature" role="listitem">Partage de Médias</div>
          <div class="feature" role="listitem">Ateliers Créatifs</div>
        </div>
      </section>

      <aside class="card" aria-label="Portail d'authentification">

        <div id="signup-section" class="form-section">
          <h2 class="form-title">Créer un compte</h2>
          <form id="signup-form" autocomplete="on" novalidate>
            <div class="field"><label for="signup-firstname">Prénom</label><input id="signup-firstname" type="text" placeholder="Ton prénom" required autocomplete="given-name" /></div>
            <div class="field"><label for="signup-lastname">Nom</label><input id="signup-lastname" type="text" placeholder="Ton nom" required autocomplete="family-name" /></div>
            <div class="field"><label for="signup-dob">Date de naissance</label><input id="signup-dob" type="date" required autocomplete="bday" /></div>
            <div class="field"><label for="signup-email">Adresse e-mail</label><input id="signup-email" type="email" placeholder="explorateur@email.com" required autocomplete="email" /></div>
            <div class="field"><label for="signup-password">Mot de passe sécurisé</label><input id="signup-password" type="password" placeholder="Majuscule, minuscule, chiffre" minlength="6" required autocomplete="new-password" /></div>
            <button class="btn" type="submit" id="signup-button">Rejoindre Harmonia</button>
            <div id="signup-msg" class="msg"></div>
          </form>
          <div class="separator"><span>ou</span></div>
          <div class="providers">
            <button type="button" class="provider-btn" data-provider="google"><span class="icon g">G</span> Continuer via Google</button>
            <button type="button" class="provider-btn" data-provider="facebook"><span class="icon f">f</span> Continuer via Facebook</button>
          </div>
        </div>

        <hr class="card-divider">

        <div id="login-section" class="form-section">
            <h2 class="form-title">Se connecter</h2>
            <form id="login-form" autocomplete="on">
              <div class="field"><label for="login-email">Adresse e-mail</label><input id="login-email" type="email" placeholder="Votre e-mail" required autocomplete="email" /></div>
              <div class="field"><label for="login-password">Mot de passe</label><input id="login-password" type="password" placeholder="Votre mot de passe" required autocomplete="current-password" /></div>
              <button class="btn" type="submit" id="login-button">Entrer sur Harmonia</button>
              <div id="login-msg" class="msg"></div>
            </form>
        </div>

        <hr class="card-divider">

        <div id="reset-section" class="form-section">
            <h2 class="form-title">Mot de passe oublié</h2>
            <form id="reset-form">
              <div class="field"><label for="reset-email">E-mail de récupération</label><input id="reset-email" type="email" placeholder="Votre e-mail" required autocomplete="email" /></div>
              <button class="btn" type="submit" id="reset-button">Envoyer le lien</button>
              <div id="reset-msg" class="msg"></div>
            </form>
        </div>

      </aside>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- CONFIGURATION ---
      const REDIRECT_URL = "home.html";
      const PASSWORD_REGEX = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$/;

      // Wait for GoTrue to be available
      if (typeof GoTrue === 'undefined') {
        console.error('GoTrue (gotrue-js) is not loaded. Vérifie la balise <script src="...gotrue.min.js">.');
        // show user-friendly message
        const signupMsg = document.getElementById('signup-msg');
        signupMsg && (signupMsg.textContent = "Erreur interne : service d'authentification indisponible. Réessaye plus tard." , signupMsg.className='msg is-error is-visible');
        return;
      }

      const auth = new GoTrue({
        APIUrl: "https://signupharmonia.netlify.app/.netlify/identity",
        setCookie: true,
      });

      // --- SÉLECTION DES ÉLÉMENTS DU DOM ---
      const dom = {
        providerBtns: document.querySelectorAll('.provider-btn'),
        forms: {
          signup: document.getElementById('signup-form'),
          login: document.getElementById('login-form'),
          reset: document.getElementById('reset-form'),
        },
        msgs: {
          signup: document.getElementById('signup-msg'),
          login: document.getElementById('login-msg'),
          reset: document.getElementById('reset-msg'),
        },
        buttons: {
          signup: document.getElementById('signup-button'),
          login: document.getElementById('login-button'),
          reset: document.getElementById('reset-button'),
        }
      };

      // --- UTILITAIRES ---
      const showMsg = (el, text, type = 'is-error') => {
        if (!el) return console.warn('showMsg appelé sans élément');
        el.textContent = text;
        el.className = `msg ${type} is-visible`;
      };

      const clearAllMsgs = () => {
        Object.values(dom.msgs).forEach(msgEl => { if(msgEl) msgEl.className = 'msg'; });
      };

      const setButtonsDisabled = (disabled) => {
        Object.values(dom.buttons).forEach(button => { if(button) button.disabled = disabled; });
      };

      // --- AUTH LOGIC ---
      const handleOAuth = (provider) => {
        // Using Netlify OAuth endpoint
        window.location.href = `/.netlify/identity/authorize?provider=${provider}`;
      };

      const parseError = async (err) => {
        // gotrue sometimes returns a Response object or Error object
        try {
          if (!err) return 'Erreur inconnue';
          if (err.json) {
            const data = await err.json();
            return data && (data.msg || data.message || JSON.stringify(data)) || err.statusText || 'Erreur serveur';
          }
          return err.message || String(err);
        } catch (e) {
          return err.message || 'Erreur inconnue';
        }
      };

      const handleSignup = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        clearAllMsgs();
        setButtonsDisabled(true);

        try {
          const form = dom.forms.signup;
          const firstname = form.querySelector('#signup-firstname').value.trim();
          const lastname = form.querySelector('#signup-lastname').value.trim();
          const dob = form.querySelector('#signup-dob').value;
          const email = form.querySelector('#signup-email').value.trim();
          const password = form.querySelector('#signup-password').value;

          if (!firstname || !lastname || !dob || !email || !password) {
              showMsg(dom.msgs.signup, 'Tous les champs sont obligatoires.', 'is-error');
              setButtonsDisabled(false);
              return;
          }
          if (password.length < 6) {
              showMsg(dom.msgs.signup, 'Le mot de passe doit faire au moins 6 caractères.', 'is-error');
              setButtonsDisabled(false);
              return;
          }
          if (!PASSWORD_REGEX.test(password)) {
              showMsg(dom.msgs.signup, 'Le mot de passe doit contenir une majuscule, une minuscule et un chiffre.', 'is-error');
              setButtonsDisabled(false);
              return;
          }

          const userMetadata = { data: { first_name: firstname, last_name: lastname, date_of_birth: dob } };

          console.log('Tentative d\'inscription pour', email);
          // gotrue signup call
          const res = await auth.signup(email, password, userMetadata);

          // résulat : res peut contenir user object ou confirmation info
          console.log('Résultat signup:', res);

          // show success message
          showMsg(dom.msgs.signup,
            "Compte créé ! Un e-mail de confirmation a été envoyé. Vérifiez votre boîte de réception (et le dossier Spam). Si vous ne le recevez pas, regarde dans Netlify → Identity → Users.",
            'is-success');

        } catch (err) {
          // parse error response (plus friendly)
          const parsed = await parseError(err);
          console.error('Erreur inscription détaillée:', err, parsed);
          showMsg(dom.msgs.signup, parsed, 'is-error');
        } finally {
          setButtonsDisabled(false);
        }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        clearAllMsgs();
        setButtonsDisabled(true);

        try {
          const email = dom.forms.login.querySelector('#login-email').value.trim();
          const password = dom.forms.login.querySelector('#login-password').value;

          console.log('Tentative login', email);
          await auth.login(email, password, true);
          // success → redirect
          window.location.href = REDIRECT_URL;
        } catch (err) {
          console.error('Erreur connexion brute:', err);
          // parse common gotrue errors
          let parsed = err.message || 'Email ou mot de passe incorrect.';
          try {
            parsed = await parseError(err);
          } catch (_) {}
          showMsg(dom.msgs.login, parsed || 'Email ou mot de passe incorrect.', 'is-error');
          setButtonsDisabled(false);
        }
      };

      const handleReset = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        clearAllMsgs();
        setButtonsDisabled(true);

        const email = dom.forms.reset.querySelector('#reset-email').value.trim();
        try {
          await auth.requestPasswordRecovery(email);
        } catch (err) {
          console.error('Erreur requestPasswordRecovery:', err);
        } finally {
          showMsg(dom.msgs.reset, "Si un compte avec cet e-mail existe, un lien de récupération a été envoyé.", 'is-success');
          setButtonsDisabled(false);
        }
      };

      // --- ÉCOUTEURS ---
      dom.providerBtns.forEach(btn => btn.addEventListener('click', () => handleOAuth(btn.dataset.provider)));
      dom.forms.signup.addEventListener('submit', handleSignup);
      dom.forms.login.addEventListener('submit', handleLogin);
      dom.forms.reset.addEventListener('submit', handleReset);

      // --- Sécurité : empêcher double submit via Enter sur les champs (optionnel) ---
      ['signup', 'login', 'reset'].forEach(k => {
        const f = dom.forms[k];
        if (!f) return;
        f.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            // Let submit happen normally (handlers manage it). This avoids accidental double submits.
          }
        });
      });

      // --- Vérification initiale de session ---
      try {
        const current = auth.currentUser && auth.currentUser();
        if (current) {
          // redirect user if already logged in
          window.location.href = REDIRECT_URL;
        }
      } catch (e) {
        // ignore
      }
    });
  </script>
</body>
</html>
